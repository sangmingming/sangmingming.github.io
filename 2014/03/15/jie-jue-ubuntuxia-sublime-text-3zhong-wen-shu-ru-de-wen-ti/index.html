<!DOCTYPE html><html lang="Chinese"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 解决Ubuntu下Sublime text 3中文输入的问题 · 码农明明桑</title><meta name="description" content="解决Ubuntu下Sublime text 3中文输入的问题 - Sam"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.isming.me/atom.xml" title="码农明明桑"></head><body><div class="wrap"><header><a href="/" class="logo-link"><!--img(src=url_for(theme.logo) alt="logo")--><h1>码农明明桑</h1></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/links" target="_self" class="nav-list-link">FRIENDS</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">解决Ubuntu下Sublime text 3中文输入的问题</h1><div class="post-info">Mar 15, 2014</div><div class="post-content"><p>好久之前便听朋友说起Sublime Text这款软件很好用，终于这几天有空折腾，把软件给装起来了。用起来确实很不错，写代码很爽。<br>但是用了一段时间之后，我需要输入中文了，无论怎么切换输入法，都无法切换到中文。<br>网上搜索了一下，原来这是Bug。找解决方法吧。下面介绍我的解决方案，是大神cjacker解决成功的啦，我只是copy一下，方便大家在遇到这个问题的时候可以方便解决。<br><a id="more"></a></p>
<pre><code>我的系统：ubuntu 13.04  
我的输入法：fcitx   
sublime版本：3059    
</code></pre><p>理论上支持 <code>sublime text2/3</code></p>
<p>1.保存代码sublime-imfix.c</p>
<pre><code>/*
sublime-imfix.c
Use LD_PRELOAD to interpose some function to fix sublime input method support for linux.
By Cjacker Huang &lt;jianzhong.huang at i-soft.com.cn&gt;

gcc -shared -o libsublime-imfix.so sublime_imfix.c  `pkg-config --libs --cflags gtk+-2.0` -fPIC
LD_PRELOAD=./libsublime-imfix.so sublime_text
*/
#include &lt;gtk/gtk.h&gt;
#include &lt;gdk/gdkx.h&gt;
typedef GdkSegment GdkRegionBox;

struct _GdkRegion
{
      long size;
      long numRects;
      GdkRegionBox *rects;
      GdkRegionBox extents;
};

GtkIMContext *local_context;

void
gdk_region_get_clipbox (const GdkRegion *region,
        GdkRectangle    *rectangle)
{    
      g_return_if_fail (region != NULL);
      g_return_if_fail (rectangle != NULL);

      rectangle-&gt;x = region-&gt;extents.x1;
      rectangle-&gt;y = region-&gt;extents.y1;
      rectangle-&gt;width = region-&gt;extents.x2 - region-&gt;extents.x1;
      rectangle-&gt;height = region-&gt;extents.y2 - region-&gt;extents.y1;
      GdkRectangle rect;
      rect.x = rectangle-&gt;x;
      rect.y = rectangle-&gt;y;
      rect.width = 0;
      rect.height = rectangle-&gt;height; 
      //The caret width is 2; 
      //Maybe sometimes we will make a mistake, but for most of the time, it should be the caret.
      if(rectangle-&gt;width == 2 &amp;&amp; GTK_IS_IM_CONTEXT(local_context)) {
        gtk_im_context_set_cursor_location(local_context, rectangle);
      }
}

//this is needed, for example, if you input something in file dialog and return back the edit area
//context will lost, so here we set it again.

static GdkFilterReturn event_filter (GdkXEvent *xevent, GdkEvent *event, gpointer im_context)
{
    XEvent *xev = (XEvent *)xevent;
    if(xev-&gt;type == KeyRelease &amp;&amp; GTK_IS_IM_CONTEXT(im_context)) {
           GdkWindow * win = g_object_get_data(G_OBJECT(im_context),&quot;window&quot;);
           if(GDK_IS_WINDOW(win))
             gtk_im_context_set_client_window(im_context, win);
    }
    return GDK_FILTER_CONTINUE;
}

void gtk_im_context_set_client_window (GtkIMContext *context,
      GdkWindow    *window)
{
      GtkIMContextClass *klass;
      g_return_if_fail (GTK_IS_IM_CONTEXT (context));
      klass = GTK_IM_CONTEXT_GET_CLASS (context);
      if (klass-&gt;set_client_window)
    klass-&gt;set_client_window (context, window);

      if(!GDK_IS_WINDOW (window))
    return;
      g_object_set_data(G_OBJECT(context),&quot;window&quot;,window);
      int width = gdk_window_get_width(window);
      int height = gdk_window_get_height(window);
      if(width != 0 &amp;&amp; height !=0) {
        gtk_im_context_focus_in(context);
        local_context = context;
      }
      gdk_window_add_filter (window, event_filter, context); 
}
</code></pre><p>2.安装C/C++的编译环境和gtk libgtk2.0-dev</p>
<pre><code>sudo    apt-get install build-essential
sudo apt-get install libgtk2.0-dev
</code></pre><p>3.编译共享内存</p>
<pre><code>gcc -shared -o libsublime-imfix.so sublime_imfix.c  `pkg-config --libs --cflags gtk+-2.0` -fPIC
</code></pre><p>4.启动测试</p>
<pre><code>LD_PRELOAD = ./libsublime-imfix.so sublime_text
</code></pre><p>正常的话这样是没有问题的。</p>
<p>然后我们在修改我们的desktop文件，使图标也可以使用</p>
<pre><code>sudo vi /usr/share/applications/sublime-text.desktop
</code></pre><p>先将so文件移动到sublime text的目录</p>
<p>然后按照如下替换（主要是每次执行之前，去预加载我们的libsublime-imfix.so库）</p>
<pre><code>[Desktop Entry]
Version=1.0
Type=Application
Name=Sublime Text
GenericName=Text Editor
Comment=Sophisticated text editor for code, markup and prose
Exec=bash -c &apos;LD_PRELOAD=/opt/sublime_text/libsublime-imfix.so /opt/sublime_text/sublime_text&apos; %F
Terminal=false
MimeType=text/plain;
Icon=sublime-text
Categories=TextEditor;Development;
StartupNotify=true
Actions=Window;Document;

[Desktop Action Window]
Name=New Window
Exec=bash -c &apos;LD_PRELOAD=/opt/sublime_text/libsublime-imfix.so /opt/sublime_text/sublime_text&apos; -n
OnlyShowIn=Unity;

[Desktop Action Document]
Name=New File
Exec=bash -c &apos;LD_PRELOAD=/opt/sublime_text/libsublime-imfix.so /opt/sublime_text/sublime_text&apos; --command new_file
OnlyShowIn=Unity;
</code></pre></div></article></div></main><footer><div class="paginator"><a href="/2014/03/16/androidyi-bu-cao-zuo-zong-jie/" class="prev">上一篇</a><a href="/2013/11/18/git-use-skill/" class="next">下一篇</a></div><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><script>var cloudTieConfig = {
    url: document.location.href,
    sourceId: "2014/03/15/jie-jue-ubuntuxia-sublime-text-3zhong-wen-shu-ru-de-wen-ti/",
    productKey: "a094f65b0cf3436d922737584f8a4bb2",
    target: "cloud-tie-wrapper"
};
var yunManualLoad = true;
Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);</script><div class="copyright"><p>© 2013 - 2017 <a href="http://blog.isming.me">Sam</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script src="//hm.baidu.com/h.js?c22f102f5fbaa79cf43b93add1805f4f"></script></body></html>