<!DOCTYPE html><html lang="Chinese"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 聊聊Android N开始支持的Lambda · 码农明明桑</title><meta name="description" content="聊聊Android N开始支持的Lambda - Sam"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.isming.me/atom.xml" title="码农明明桑"></head><body><div class="wrap"><header><a href="/" class="logo-link"><!--img(src=url_for(theme.logo) alt="logo")--><h1>码农明明桑</h1></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/links" target="_self" class="nav-list-link">FRIENDS</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">聊聊Android N开始支持的Lambda</h1><div class="post-info">Sep 13, 2016</div><div class="post-content"><p>Android N 正式版已经发布了。对于开发者来说一个重大的更新是对于Java支持到了Java8，其中一点就是支持Lambda。我们就来聊聊什么是lambda，怎么在Android中使用。</p>
<h3 id="什么是lambda"><a href="#什么是lambda" class="headerlink" title="什么是lambda"></a>什么是lambda</h3><p>Lambda 可以理解为匿名函数,帮助我们写出更加简洁的代码。</p>
<a id="more"></a>
<p>给view设置一个clicklistener，原本你需要写出这样的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">v.setOnClickListener(<span class="keyword">new</span> View.OnClickListener(View v) &#123;</div><div class="line"> <span class="meta">@Override</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line"> Toast.makeText(getActivity(), <span class="string">"clicked"</span>, Toast.LENGTH_LONG).show()</div><div class="line"> &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>使用lambda之后:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">.setOnClickListener(v -&gt; Toast.makeText(getActivity(), <span class="string">"clicked"</span>, Toast.LENGTH_LONG).show());</div></pre></td></tr></table></figure>
<p>是不是代码量爆减。这里再看下怎么写lambda。</p>
<p>在JavaScript，python等语言中函数是一等公民，但是Java中类才是。使用lambda时候，lambda其实应该是一个对象，依附于函数式接口（只包含一个抽象方法声明的接口，例如刚刚我们举例的<code>OnClickListener</code>就是,在Java 8 需要使用<code>@FunctionalInterface</code>这样保证在编译的时候一个接口只有一个抽象注解）。</p>
<p>写法的基本规则是这样:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(arguments) -&gt; &#123;body&#125;</div></pre></td></tr></table></figure>
<p>arguments 是参数列表，0~n个， 参数为一个时候，可以不要括号<br>body 为具体代码部分，如果代码只有一句的话可以不要大括号<br>返回值会自动推导出类型    </p>
<p>一些写法实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">(<span class="keyword">int</span> a, <span class="keyword">int</span> b) -&gt; &#123;  <span class="keyword">return</span> a + b; &#125;</div><div class="line"></div><div class="line">() -&gt; System.out.println(<span class="string">"Hello World"</span>);</div><div class="line"></div><div class="line">(String s) -&gt; System.out.println(s);</div><div class="line"></div><div class="line">() -&gt; <span class="number">42</span></div><div class="line"></div><div class="line">() -&gt; &#123; <span class="keyword">return</span> <span class="number">3.1415</span> &#125;;</div><div class="line">(a, b) -&gt; &#123;<span class="keyword">return</span> a+b;&#125;</div></pre></td></tr></table></figure>
<p>另外一点需要注意的是，在我们的lambda表达式中<code>this</code>关键指的是外部对象，而不是我们以为的lambda这个对象。在语法糖的实现过程中，lambda表达式最后会被变为类的私有方法，因此可以放心的使用this。</p>
<h3 id="使用retrolambda"><a href="#使用retrolambda" class="headerlink" title="使用retrolambda"></a>使用retrolambda</h3><p>目前有个比较成熟的解决方案，使用<code>retrolambd</code>,接入的配置如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">apply <span class="string">plugin:</span> <span class="string">'com.android.application'</span> </div><div class="line">apply <span class="string">plugin:</span><span class="string">'me.tatarka.retrolambda'</span></div><div class="line"></div><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        mavenCentral()</div><div class="line">    &#125;</div><div class="line"></div><div class="line"> dependencies &#123;</div><div class="line">     classpath <span class="string">'me.tatarka:gradle-retrolambda:3.2.5'</span></div><div class="line"> &#125; </div><div class="line">&#125;</div><div class="line">  <span class="comment">// Required because retrolambda is on maven central</span></div><div class="line">repositories &#123;</div><div class="line">    mavenCentral() </div><div class="line">&#125;</div><div class="line"> android &#123;   </div><div class="line">     compileOptions &#123;</div><div class="line">        sourceCompatibility JavaVersion.VERSION_1_8</div><div class="line">        targetCompatibility JavaVersion.VERSION_1_8   </div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//指定将源码编译的级别，以下会将代码编译到1.7的自己码格式</span></div><div class="line">retrolambda &#123;</div><div class="line">	javaVersion JavaVersion.VERSION_1_7</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当前，retrolambda对于android gradle插件是有依赖的，需要使用1.5+的插件才可以。</p>
<p>retrolambda的原理是在编译的过程中，给class文件增加包裹，转成java 1.7支持的格式。</p>
<h3 id="使用jack"><a href="#使用jack" class="headerlink" title="使用jack"></a>使用jack</h3><p>在Android N，支持使用Java 8， google给我们提供了新的编译工具<code>jack</code>,因此可以直接支持lambda，为了支持低版本的Android也可以用lambda，我们需要将<code>targetSdkVersion</code>和<code>compileSdkVersion</code>设置为23或者更小。启用jack，修改<code>build.gradle</code>如下。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">  ...</div><div class="line">  defaultConfig &#123;</div><div class="line">    ...</div><div class="line">    jackOptions &#123;</div><div class="line">      enabled <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  compileOptions &#123;</div><div class="line">    sourceCompatibility JavaVersion.VERSION_1_8</div><div class="line">    targetCompatibility JavaVersion.VERSION_1_8</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>jack工具链会的编译步骤如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Jack (.java --&gt; .jack --&gt; .dex)</div></pre></td></tr></table></figure></p>
<p>和之前相比，将中间转换为class文件的步骤省略了，不需要多个工具链。<br>在低版本兼容lambda，也同样是使用的语法糖来实现。</p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>如上两种工具都可以让我们在进行Android开发的时候来使用lambda，retrolambda出来的时间更早，经过很多次的迭代，目前也有一些app在使用，相比较来说更加成熟。jack则是google开发，减少了对javac的依赖，更多谷歌的自主性，相信后面谷歌大力推广的，但是出于刚刚开发出来因此还不够成熟，对于lint，proguard，instant run还有很多地方支持不好的地方，我们相信以后jack会是趋势。</p>
<p>出于尝鲜，还是可以来使用的，但是在大的项目里面还是不建议使用的，毕竟万一出了问题还是很难排查的。</p>
<p>另外，如果想要在android开发更爽快的使用lambda，也可以去试试<code>kotlin</code>这个语言。</p>
<p>参考资料:      </p>
<ol>
<li><a href="http://viralpatel.net/blogs/Lambda-expressions-java-tutorial/" target="_blank" rel="external">http://viralpatel.net/blogs/Lambda-expressions-java-tutorial/</a>       </li>
<li><a href="https://developer.android.com/guide/platform/j8-jack.html" target="_blank" rel="external">https://developer.android.com/guide/platform/j8-jack.html</a>     </li>
<li><a href="https://github.com/evant/gradle-retrolambda" target="_blank" rel="external">https://github.com/evant/gradle-retrolambda</a></li>
</ol>
<blockquote>
<p>原文地址：<a href="http://blog.isming.me/2016/09/13/android-lambda/">http://blog.isming.me/2016/09/13/android-lambda/</a>，转载请注明出处。</p>
</blockquote>
</div></article></div></main><footer><div class="paginator"><a href="/2017/05/18/android-architecture-components-guide/" class="prev">上一篇</a><a href="/2016/08/08/red-android-evolution/" class="next">下一篇</a></div><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><script>var cloudTieConfig = {
    url: document.location.href,
    sourceId: "2016/09/13/android-lambda/",
    productKey: "a094f65b0cf3436d922737584f8a4bb2",
    target: "cloud-tie-wrapper"
};
var yunManualLoad = true;
Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);</script><div class="copyright"><p>© 2013 - 2017 <a href="http://blog.isming.me">Sam</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script src="//hm.baidu.com/h.js?c22f102f5fbaa79cf43b93add1805f4f"></script></body></html>